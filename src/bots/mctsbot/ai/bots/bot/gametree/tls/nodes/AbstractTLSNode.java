package bots.mctsbot.ai.bots.bot.gametree.tls.nodes;

import java.util.ArrayList;
import java.util.List;

import bots.mctsbot.ai.bots.bot.gametree.action.SearchBotAction;
import bots.mctsbot.ai.bots.bot.gametree.mcts.strategies.backpropagation.BackPropagationStrategy;
import bots.mctsbot.ai.bots.bot.gametree.tls.SimulatedGame;
import bots.mctsbot.ai.bots.bot.gametree.tls.strategies.selection.SelectionStrategy;
import bots.mctsbot.ai.bots.bot.gametree.tls.tests.Test;

public abstract class AbstractTLSNode {

	protected AbstractTLSNode leftChild;
	protected AbstractTLSNode rightChild;

	private final TLSTree tree;

	protected BackPropagationStrategy backPropagationStrategy;

	private int nbSamples = 0;

	protected List<Test> possibleTests = new ArrayList<Test>();

	public AbstractTLSNode(AbstractTLSNode parent, TLSTree tree) {
		this.parent = parent;
		this.tree = tree;
	}

	private final AbstractTLSNode parent;

	public AbstractTLSNode getLeftChild() {
		return leftChild;
	}

	public AbstractTLSNode getRightChild() {
		return rightChild;
	}

	public AbstractTLSNode selectChild(SelectionStrategy strategy) {
		return strategy.select(this);
	}

	public AbstractTLSNode getParent() {
		return parent;
	}

	public void backPropagate(double value, SimulatedGame game) {
		SearchBotAction action = game.peek();
		if (!isSplit()) {
			for (Test test : possibleTests) {
				test.updateStats(action, value);
			}
		}
		backPropagationStrategy.onBackPropagate(value);
		this.getParent().backPropagate(value, game);
	}

	protected boolean isSplit() {
		return rightChild != null;
	}

	/**
	 * For now when a node is split, all information down the tree is lost.
	 */
	public void split() {
		leftChild = new LeafNode(getParent(), getTree());
		rightChild = new LeafNode(getParent(), getTree());
	}

	public int getNbSamples() {
		return nbSamples;
	}

	public double getEVStdDev() {
		return backPropagationStrategy.getEVStdDev();
	}

	public double getStdDev() {
		return backPropagationStrategy.getStdDev();
	}

	public double getEV() {
		return backPropagationStrategy.getEV();
	}

	public TLSTree getTree() {
		return tree;
	}

}

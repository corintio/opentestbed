package game;

import static org.junit.Assert.assertEquals;
import game.deck.Deck;
import game.deck.MockDeck;

import org.apache.commons.io.IOUtils;
import org.junit.Test;

import bots.BotLoggingDecorator;
import bots.demobots.AlwaysCallBot;

import com.biotools.meerkat.Action;
import com.biotools.meerkat.GameInfo;
import com.biotools.meerkat.Player;

/**
 * Tests the workings of the Dealer class
 *
 */
public class DealerTest {

	/**
	 * Tests that dealing a hand produces the right events
	 * to GameObservers/Players<br>
	 * The hand we play here was run in PokerAcademy, events that need
	 * to be generated were 'recorded' with a LoggingBot so we test
	 * for the same events and order
	 * @throws Exception
	 */
	@Test
	public void testGameEventsForPlayer() throws Exception {
		Deck deck = new MockDeck(new String[] { "Jh 9h 2h 3c 5h" }, new String[] { "As Ks|2s 8d|8h Qc" });
		PublicGameInfo gameInfo = new PublicGameInfo();
		gameInfo.setNumSeats(3);
		gameInfo.setPlayer(0, PublicPlayerInfo.create("player0", 200, new FirstRaiseBot()));
		gameInfo.setPlayer(1, PublicPlayerInfo.create("player1", 200, new AlwaysCallBot()));
		BotLoggingDecorator botLog = new BotLoggingDecorator(new AlwaysCallBot(), true);
		gameInfo.setPlayer(2, PublicPlayerInfo.create("player2", 200, botLog));
		gameInfo.setBlinds(0.05, 0.10);

		Dealer dealer = new Dealer(deck, gameInfo);
		dealer.playHand();

		String playerLog = IOUtils.toString(this.getClass().getResourceAsStream("./playerTestLog1.txt")).replace("\r", "");
		assertEquals(playerLog, botLog.getLog());
	}

	/**
	 * tests the win-amount - the last raiser doesn't 'win' his uncontested raise.<br>
	 * all player limp the blind (pot =0.3) but one raises additional $5.
	 * Nevertheless he just wins 0.3, and gets returned his raise<br>
	 * We need to be this exact to not confuse PokerTracker and HoldEm-Manager
	 * @throws Exception
	 */
	@Test
	public void testWinAmount() throws Exception {
		Deck deck = new MockDeck(new String[] { "Jh 9h 2h 3c 5h" }, new String[] { "As Ks|2s 8d|8h Qc" });
		PublicGameInfo gameInfo = new PublicGameInfo();
		gameInfo.setNumSeats(3);
		gameInfo.setBlinds(0.05, 0.10);

		// we use one player at all seats
		Player mockPlayer = new PrerecordedPlayerMock( //
				Action.callAction(0.10), // player2: call BB
				Action.raiseAction(0.05, 5), // player0 (SB): raise BB
				Action.foldAction(5.00), // player1 (BB): fold
				Action.foldAction(5.00) // player2 : fold
		);

		gameInfo.setPlayer(0, PublicPlayerInfo.create("player0 Dealer", 200, mockPlayer));
		gameInfo.setPlayer(1, PublicPlayerInfo.create("player1 SB", 200, mockPlayer));
		BotLoggingDecorator botLog = new BotLoggingDecorator(mockPlayer, false);
		gameInfo.setPlayer(2, PublicPlayerInfo.create("player2 BB", 200, botLog));

		Dealer dealer = new Dealer(deck, gameInfo);
		dealer.playHand();

		String playerLog = IOUtils.toString(this.getClass().getResourceAsStream("./playerTestLog_winAmount.txt")).replace("\r", "");
		assertEquals(playerLog, botLog.getLog());

		assertEquals(199.90, gameInfo.getPlayer(0).getBankRoll(), 0.001);
		assertEquals(200.20, gameInfo.getPlayer(1).getBankRoll(), 0.001);
		assertEquals(199.90, gameInfo.getPlayer(2).getBankRoll(), 0.001);
	}

	/**
	 * This hand starts preflop with calls and on the flop with a raise. All players
	 * fold, so the pot goes to the raise uncontested
	 * @throws Exception
	 */
	@Test
	public void testFoldedGameFlop() throws Exception {
		Deck deck = new MockDeck(new String[] { "Jh 9h 2h 3c 5h" }, new String[] { "As Ks|2s 8d|8h Qc" });
		PublicGameInfo gameInfo = new PublicGameInfo();
		gameInfo.setNumSeats(3);
		gameInfo.setBlinds(0.05, 0.10);

		// we use one player at all seats
		Player mockPlayer=new PrerecordedPlayerMock( //
				Action.callAction(0.10), // player2: call BB
				Action.callAction(0.05), // player0 (SB): call BB
				Action.checkAction(),    // player1 (BB): check
				                         // -- flop --
				Action.betAction(0.10),  // player0: bet
				Action.foldAction(0.10),  // player1: fold
				Action.foldAction(0.10)  // player2: fold
				);
				
		gameInfo.setPlayer(0, PublicPlayerInfo.create("player0", 200, mockPlayer));
		gameInfo.setPlayer(1, PublicPlayerInfo.create("player1", 200, mockPlayer));
		BotLoggingDecorator botLog = new BotLoggingDecorator(mockPlayer, false);
		gameInfo.setPlayer(2, PublicPlayerInfo.create("player2", 200, botLog));

		Dealer dealer = new Dealer(deck, gameInfo);
		dealer.playHand();

		String playerLog = IOUtils.toString(this.getClass().getResourceAsStream("./playerTestLog_FoldedFlopGame.txt")).replace("\r", "");
		assertEquals(playerLog, botLog.getLog());
	}

	/**
	 * This hand starts preflop with folds.<br>
	 * Thus the bigblind doesn't need to act and wins
	 * @throws Exception
	 */
	@Test
	public void testFoldedGamePreFlop() throws Exception {
		Deck deck = new MockDeck(new String[] { "Jh 9h 2h 3c 5h" }, new String[] { "As Ks|2s 8d|8h Qc" });
		PublicGameInfo gameInfo = new PublicGameInfo();
		gameInfo.setNumSeats(3);
		gameInfo.setBlinds(0.05, 0.10);

		// we use one player at all seats
		Player mockPlayer = new PrerecordedPlayerMock( //
				Action.foldAction(0.10), // player2: fold
				Action.foldAction(0.05) // player0 (SB): fold
		);

		gameInfo.setPlayer(0, PublicPlayerInfo.create("player0", 200, mockPlayer));
		gameInfo.setPlayer(1, PublicPlayerInfo.create("player1", 200, mockPlayer));
		BotLoggingDecorator botLog = new BotLoggingDecorator(mockPlayer, false);
		gameInfo.setPlayer(2, PublicPlayerInfo.create("player2", 200, botLog));

		Dealer dealer = new Dealer(deck, gameInfo);
		dealer.playHand();

		String playerLog = IOUtils.toString(this.getClass().getResourceAsStream("./playerTestLog_FoldedPreFlopGame.txt")).replace("\r", "");
		assertEquals(playerLog, botLog.getLog());
	}

	/**
	 * This hand starts preflop with calls and on the flop with an all-in. 
	 * One player calls.<br>
	 * The players must now reveal cards, the game progresses to showdown (
	 * i.e. turn + river cards are revealed).<br>
	 * The hand we play here was run in PokerAcademy, events that need
	 * to be generated were 'recorded' with a LoggingBot so we test
	 * for the same events and order
	 * @throws Exception
	 */
	@Test
	public void testAllInGame() throws Exception {
		Deck deck = new MockDeck(new String[] { "Jh 9h 2h 3c 5h" }, new String[] { "As Ks|2s 8d|8h Qc" });
		PublicGameInfo gameInfo = new PublicGameInfo();
		gameInfo.setNumSeats(3);
		gameInfo.setBlinds(0.05, 0.10);

		// we use one player at all seats
		Player mockPlayer = new PrerecordedPlayerMock( //
				Action.callAction(0.10), // player2: call BB
				Action.callAction(0.05), // player0 (SB): call BB
				Action.checkAction(), // player1 (BB): check
				// -- flop --
				Action.betAction(0.90), // player0: all-in bet
				Action.callAction(0.90), // player1: all-in call
				Action.foldAction(0.90) // player2: fold
		);

		gameInfo.setPlayer(0, PublicPlayerInfo.create("player0", 1, mockPlayer));
		gameInfo.setPlayer(1, PublicPlayerInfo.create("player1", 1, mockPlayer));
		BotLoggingDecorator botLog = new BotLoggingDecorator(mockPlayer, false);
		gameInfo.setPlayer(2, PublicPlayerInfo.create("player2", 1, botLog));

		Dealer dealer = new Dealer(deck, gameInfo);
		dealer.playHand();

		String playerLog = IOUtils.toString(this.getClass().getResourceAsStream("./playerTestLog_AllInGame.txt")).replace("\r", "");
		assertEquals(playerLog, botLog.getLog());
	}

	/**
	 * simple Testbot, whose first action is to raise
	 *
	 */
	class FirstRaiseBot extends AlwaysCallBot {
		private int counter = 0;
		private GameInfo gameInfo;

		@Override
		public void gameStartEvent(GameInfo gInfo) {
			this.gameInfo = gInfo;
			super.gameStartEvent(gInfo);
		}

		@Override
		public Action getAction() {
			if (counter++ == 0) {
				return Action.raiseAction(gameInfo, 0.1);
			}
			return super.getAction();
		}
	}

}
